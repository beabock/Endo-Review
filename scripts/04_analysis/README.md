# Analysis scripts (scripts/04_analysis)

This folder contains analysis, extraction, visualization, and validation helper scripts used after predictions are generated by the model pipeline.

Purpose: provide a short description, inputs, outputs, and quick usage notes for every script in this folder. Run these scripts from the repository root so relative paths (e.g. `results/` and `models/`) resolve correctly.

---

## Reference Data Utilities

- `reference_data_utils.R`
  - Purpose: **Centralized reference data definitions** for consistent analysis across all scripts. Provides standardized country classifications (Global North/South), plant parts keywords, research method keywords, geographic terms, and utility functions for data standardization.
  - Functions: `get_country_classifications()`, `get_plant_parts_keywords()`, `get_method_keywords()`, `get_geographic_keywords()`, `get_continent_keywords()`, `get_region_keywords()`, `standardize_country_name()`, `filter_country_homonyms()`, `get_biodiversity_hotspots()`.
  - Usage: Source this file at the top of analysis scripts: `source("scripts/04_analysis/reference_data_utils.R")`.
  - Benefits: Single source of truth for all reference data, eliminates code duplication, ensures consistency across analyses, handles problematic homonyms (e.g., Niger as country vs. species name).
  - Notes: This utility file is automatically loaded by `extract_species_simple.R` and `geographic_bias_analysis.R`. Other scripts should also source this file to use standardized definitions.

---

## Analysis Scripts

- `extract_species_simple.R`
  - Purpose: Comprehensive extraction pipeline. Combines model predictions with training data, computes confidence, runs taxa detection (species/genus/family), plant-part detection, research method detection, and geographic extraction. Uses centralized reference data utilities for consistent keyword definitions and country classifications.
  - Inputs: `results/relevant_abstracts_with_pa_predictions.csv`, `models/species.rds` (or `species.rds`), training CSV in `data/raw/`.
  - Outputs: `results/comprehensive_extraction_results.csv`, `results/species_detection_weighted_ensemble.csv`, `results/subsample_geography_check.csv`, and related CSVs.
  - Notes: This script automatically sources `reference_data_utils.R` for standardized keyword definitions. Can be memory- and time-intensive; edit batch sizes at top of file if needed. Handles problematic country/species name homonyms using centralized filtering.

- `optimized_taxa_detection.R`
  - Purpose: Fast, reusable functions for taxa detection used by the extraction pipeline. Provides lookup table creation, candidate extraction, batch validation, and parallel processing helpers.
  - Inputs: `models/species.rds` (species reference table) when running tests or examples; otherwise loaded by `extract_species_simple.R`.
  - Outputs: Functions only (no automatic output). Internal test/example blocks are disabled by default; set `run_examples <- TRUE` at the top of the file (or run interactively) to enable them.
  - Notes: Designed for Windows-friendly parallel processing (multisession). Contains `setup_parallel()` and `process_abstracts_parallel()` to speed up large datasets.

- `visualize_extraction_results.R`
  - Purpose: Creates publication-ready visualizations from `results/comprehensive_extraction_results.csv`. Generates plots for species detection, methods distribution, plant parts frequency, geographic distribution, prediction quality, etc.
  - Inputs: `results/comprehensive_extraction_results.csv` (generated by `extract_species_simple.R`).
  - Outputs: `plots/` PNGs (e.g. `plots/publication_volume_over_time.png`) and console summaries.
  - Notes: Adjust `custom_theme`, color palettes, and output paths at the top of the script.

- `visualize_taxa_results.R`
  - Purpose: Additional or alternative visualizations focused on taxa/species-specific analyses. Produces figures summarizing taxa frequency, taxonomic breakdowns, and species co-occurrence.
  - Inputs/Outputs: Same `results/comprehensive_extraction_results.csv`; writes plots in `plots/`.

- `manual_validation_sample.R`
  - Purpose: Builds a stratified validation sample for manual review. Samples across confidence levels, predicted labels (Presence/Absence), species-detected vs not, and information completeness. Saves `results/validation_sample_for_manual_review.csv` and includes a short validation instructions block.
  - Inputs: `results/comprehensive_extraction_results.csv`.
  - Outputs: `results/validation_sample_for_manual_review.csv` and optional instructions printed to console.

- `geographic_bias_analysis.R`
  - Purpose: Comprehensive analysis of geographic biases and research gaps. Analyzes Global North/South equity, country-level research patterns, and identifies understudied regions. **Now includes zero-study countries** for accurate bias assessment using centralized country classifications.
  - Inputs: `results/comprehensive_extraction_results.csv`.
  - Outputs: Console summaries, CSV files (`results/country_analysis_with_zero_studies.csv`, `results/global_north_south_comprehensive_equity.csv`), and optional plots in `plots/`.
  - Features: Uses centralized reference data utilities for consistent country classifications, handles problematic country name homonyms, identifies biodiversity hotspots with zero research, calculates true research coverage ratios accounting for all countries globally.
  - Notes: This analysis reveals the full scope of geographic bias by explicitly including countries with zero endophyte research studies, providing more accurate equity assessments than previous approaches.

- `temporal_trend_analysis.R`
  - Purpose: Analyze publication volume and research trends over time (publication counts, method evolution, geographic focus changes, species detection trends). Saves time-series plots to `plots/`.
  - Inputs: `results/comprehensive_extraction_results.csv`.
  - Outputs: `plots/publication_volume_over_time.png`, and other time-series figures.

- `absence_evidence_detection.R`
  - Purpose: Detect and analyze studies that report absence of fungal endophytes (negative results). Uses keyword- and method-based heuristics to detect likely absence evidence and summarizes by prediction type and geography.
  - Inputs: `results/comprehensive_extraction_results.csv`.
  - Outputs: Console summaries and logs about absence evidence detection.

---

## Best Practices for Reference Data

When creating new analysis scripts or modifying existing ones:

1. **Always source the reference data utilities first**: 
   ```r
   source("scripts/04_analysis/reference_data_utils.R")
   ```

2. **Use centralized functions instead of hardcoded definitions**:
   - Countries: `get_country_classifications()`, `get_all_countries()`
   - Plant parts: `get_plant_parts_keywords()`
   - Methods: `get_method_keywords()`
   - Geographic regions: `get_geographic_keywords()`

3. **Handle country name variations with standardization**:
   ```r
   standardized_name <- standardize_country_name(raw_country_name)
   ```

4. **Filter problematic homonyms** (e.g., Niger as country vs. species):
   ```r
   is_country <- filter_country_homonyms(text, country_name)
   ```

5. **Test reference data functions**:
   ```r
   test_reference_data()  # Run diagnostics
   ```

This approach ensures consistency across all analyses and makes the codebase more maintainable.

- `MANUSCRIPT_PREPARATION.md` / `COLLABORATOR_FINDINGS.*`
  - Purpose: Project-specific notes and outputs (manuscript preparation notes, collaborator findings in PDF/MD/HTML). Not a script, but useful documentation for downstream reporting.

---

## Quick usage notes
- Run `extract_species_simple.R` first to produce `results/comprehensive_extraction_results.csv`.
- Then run visualizations or analyses: `visualize_extraction_results.R`, `visualize_taxa_results.R`, `geographic_bias_analysis.R`, `temporal_trend_analysis.R`, and `absence_evidence_detection.R` as needed.
- To generate a manual validation sample run `manual_validation_sample.R` after `extract_species_simple.R`.

## Tips
- Run interactively in RStudio for easier debugging and progress monitoring. Use `Rscript` for batch runs but disable interactive test blocks in helper scripts (they are disabled by default).
- If a script errors due to missing columns (e.g. probability columns), check the upstream prediction outputs in `results/` or re-run `scripts/03_prediction/apply_models_to_full_dataset.R` to produce canonical columns (notably `final_classification`, `ensemble_presence_prob`, etc.).

